"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getCliToken = getCliToken;
exports.getClientWrapper = getClientWrapper;

var _path = _interopRequireDefault(require("path"));

var _chalk = _interopRequireDefault(require("chalk"));

var _client = _interopRequireDefault(require("@sanity/client"));

var _generateHelpUrl = require("@sanity/generate-help-url");

var _getUserConfig = require("./getUserConfig");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const apiHosts = {
  staging: 'https://api.sanity.work',
  development: 'http://api.sanity.wtf'
};
/**
 * Creates a wrapper/getter function to retrieve a Sanity API client.
 * Instead of spreading the error checking logic around the project,
 * we call it here when (and only when) a command needs to use the API
 */

const defaults = {
  requireUser: true,
  requireProject: true
};

const authErrors = () => ({
  onError: err => {
    if (!('response' in err)) {
      return err;
    }

    const statusCode = err.response && err.response.body && err.response.body.statusCode;

    if (statusCode === 401) {
      err.message = "".concat(err.message, ". You may need to login again with ").concat(_chalk.default.cyan('sanity login'), ".\nFor more information, see ").concat((0, _generateHelpUrl.generateHelpUrl)('cli-errors'), ".");
    }

    return err;
  }
});

function getCliToken() {
  // eslint-disable-next-line no-process-env
  const envAuthToken = process.env.SANITY_AUTH_TOKEN;
  const userConfig = (0, _getUserConfig.getUserConfig)();
  return envAuthToken || userConfig.get('authToken');
}

function getClientWrapper(cliApiConfig, configPath) {
  const requester = _client.default.requester.clone();

  requester.use(authErrors());
  return function (opts) {
    // Read these environment variables "late" to allow `.env` files

    /* eslint-disable no-process-env */
    const sanityEnv = process.env.SANITY_INTERNAL_ENV || 'production';
    /* eslint-enable no-process-env */

    const {
      requireUser,
      requireProject,
      api
    } = { ...defaults,
      ...opts
    };
    const token = getCliToken();
    const apiHost = apiHosts[sanityEnv];
    const apiConfig = { ...(cliApiConfig || {}),
      ...(api || {})
    };

    if (apiHost) {
      apiConfig.apiHost = apiHost;
    }

    if (requireUser && !token) {
      throw new Error('You must login first - run "sanity login"');
    }

    if (requireProject && !apiConfig.projectId) {
      const relativeConfigPath = _path.default.relative(process.cwd(), configPath);

      throw new Error("".concat(relativeConfigPath, " does not contain a project identifier (\"api.projectId\"), ") + 'which is required for the Sanity CLI to communicate with the Sanity API');
    }

    return (0, _client.default)({ ...apiConfig,
      apiVersion: '1',
      dataset: apiConfig.dataset || '~dummy-placeholder-dataset-',
      token: requireUser ? token : undefined,
      useProjectHostname: requireProject,
      requester,
      useCdn: false
    });
  };
}