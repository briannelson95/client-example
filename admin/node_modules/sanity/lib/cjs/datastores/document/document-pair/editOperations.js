"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.editOperations = void 0;

var _rxjs = require("rxjs");

var _operators = require("rxjs/operators");

var _operationArgs = require("./operationArgs");

var _operationEvents = require("./operationEvents");

var _operations = require("./operations");

const cache = new Map();

const editOperations = (ctx, idPair, typeName) => {
  const key = "".concat(idPair.publishedId, ":").concat(typeName);
  let ret = cache.get(key);

  if (!ret) {
    const operationEvents = (0, _operationEvents.getOperationEvents)(ctx); // To makes sure we connect the stream that actually performs the operations

    const operationResults$ = operationEvents(idPair, typeName).pipe((0, _operators.mergeMapTo)(_rxjs.EMPTY));
    const operationArgs$ = (0, _operationArgs.operationArgs)(ctx, idPair, typeName);
    const operations$ = operationArgs$.pipe((0, _operators.map)(_operations.createOperationsAPI));
    ret = (0, _rxjs.concat)((0, _rxjs.of)(_operations.GUARDED), (0, _rxjs.merge)(operationResults$, operations$)).pipe((0, _operators.publishReplay)(1), (0, _operators.refCount)());
    cache.set(key, ret);
  }

  return ret;
};

exports.editOperations = editOperations;