"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createDocumentStore = createDocumentStore;

var _util = require("../../util");

var _checkoutPair = require("./document-pair/checkoutPair");

var _consistencyStatus = require("./document-pair/consistencyStatus");

var _documentEvents = require("./document-pair/documentEvents");

var _editOperations = require("./document-pair/editOperations");

var _editState = require("./document-pair/editState");

var _operationEvents = require("./document-pair/operationEvents");

var _validation = require("./document-pair/validation");

var _listenQuery = require("./listenQuery");

var _resolveTypeForDocument = require("./resolveTypeForDocument");

var _initialValue = require("./initialValue");

function getIdPairFromPublished(publishedId) {
  if ((0, _util.isDraftId)(publishedId)) {
    throw new Error('editOpsOf does not expect a draft id.');
  }

  return {
    publishedId,
    draftId: (0, _util.getDraftId)(publishedId)
  };
}

function createDocumentStore(_ref) {
  let {
    client,
    documentPreviewStore,
    historyStore,
    initialValueTemplates,
    schema
  } = _ref;
  const versionedClient = client.withConfig({
    apiVersion: '2021-12-01'
  });
  const ctx = {
    client,
    documentPreviewStore,
    historyStore,
    schema
  };
  const caches = {
    pair: {
      editOperations: new Map()
    }
  };
  const operationEvents = (0, _operationEvents.getOperationEvents)(ctx);
  return {
    // Public API
    checkoutPair(idPair) {
      return (0, _checkoutPair.checkoutPair)(versionedClient, idPair);
    },

    initialValue(opts) {
      return (0, _initialValue.getInitialValueStream)(schema, initialValueTemplates, documentPreviewStore, opts);
    },

    listenQuery(query, params, options) {
      return (0, _listenQuery.listenQuery)(versionedClient, query, params, options);
    },

    resolveTypeForDocument(id, specifiedType) {
      return (0, _resolveTypeForDocument.resolveTypeForDocument)(versionedClient, id, specifiedType);
    },

    pair: {
      consistencyStatus(publishedId, type) {
        return (0, _consistencyStatus.consistencyStatus)(ctx.client, getIdPairFromPublished(publishedId), type);
      },

      documentEvents(publishedId, type) {
        return (0, _documentEvents.documentEvents)(ctx.client, getIdPairFromPublished(publishedId), type);
      },

      editOperations(publishedId, type) {
        const cache = caches.pair.editOperations;
        const key = "".concat(publishedId, ":").concat(type);

        if (!cache.has(key)) {
          cache.set(key, (0, _editOperations.editOperations)(ctx, getIdPairFromPublished(publishedId), type));
        }

        return cache.get(key);
      },

      editState(publishedId, type) {
        return (0, _editState.editState)(ctx, getIdPairFromPublished(publishedId), type);
      },

      operationEvents(publishedId, type) {
        return operationEvents(getIdPairFromPublished(publishedId), type);
      },

      validation(publishedId, type) {
        return (0, _validation.validation)(ctx, getIdPairFromPublished(publishedId), type);
      }

    }
  };
}