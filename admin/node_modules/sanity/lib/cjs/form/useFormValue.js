"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.useFormValue = useFormValue;

var _isEqual2 = _interopRequireDefault(require("lodash/isEqual"));

var _react = require("react");

var _rxjs = require("rxjs");

var _operators = require("rxjs/operators");

var _paths = require("../field/paths");

var _util = require("../util");

var _useFormBuilder = require("./useFormBuilder");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * @alpha
 */
function useFormValue(path) {
  const uniquePath = (0, _util.useUnique)(path);

  const {
    getDocument,
    patchChannel
  } = (0, _useFormBuilder.useFormBuilder)().__internal;

  const documentValueSubject = (0, _react.useMemo)(() => new _rxjs.Subject(), []);
  const documentValue$ = (0, _react.useMemo)(() => documentValueSubject.asObservable(), [documentValueSubject]);
  const [value, setValue] = (0, _react.useState)(() => (0, _paths.getValueAtPath)(getDocument(), uniquePath)); // Subscribe to all document changes

  (0, _react.useEffect)(() => patchChannel.subscribe(() => documentValueSubject.next(getDocument())), [documentValueSubject, getDocument, patchChannel]); // Subscribe to value at `path`

  (0, _react.useEffect)(() => {
    const value$ = documentValue$.pipe((0, _operators.map)(documentValue => uniquePath.length === 0 ? documentValue : (0, _paths.getValueAtPath)(documentValue, uniquePath)), (0, _operators.distinctUntilChanged)((x, y) => (0, _isEqual2.default)(x, y)));
    const sub = value$.subscribe(setValue);
    return () => sub.unsubscribe();
  }, [documentValue$, uniquePath]);
  return value;
}