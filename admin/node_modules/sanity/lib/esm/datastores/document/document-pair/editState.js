import { map, publishReplay, refCount, startWith } from 'rxjs/operators';
import { memoize } from '../utils/createMemoizer';
import { operationArgs } from './operationArgs';
import { isLiveEditEnabled } from './utils/isLiveEditEnabled'; // TODO: should we rename this?

export const editState = memoize((ctx, idPair, typeName) => {
  const liveEdit = isLiveEditEnabled(ctx.schema, typeName);
  return operationArgs(ctx, idPair, typeName).pipe(map(_ref => {
    let {
      snapshots
    } = _ref;
    return {
      id: idPair.publishedId,
      type: typeName,
      draft: snapshots.draft,
      published: snapshots.published,
      liveEdit,
      ready: true
    };
  }), startWith({
    id: idPair.publishedId,
    type: typeName,
    draft: null,
    published: null,
    liveEdit,
    ready: false
  }), publishReplay(1), refCount());
}, (_ctx, idPair, typeName) => idPair.publishedId + typeName);